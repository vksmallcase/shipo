(window.webpackJsonp=window.webpackJsonp||[]).push([[60],{4323:function(e,t,n){},4375:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return W}));var a=n(3),o=n.n(a),i=n(49),l=n.n(i),s=n(52),r=n.n(s),c=n(10),h=n.n(c),u=n(888),d=n.n(u),p=n(14),m=n.n(p),y=n(6),v=n.n(y),b=n(5),O=n.n(b),g=n(29),C=n.n(g),j=n(30),T=n.n(j),S=n(0),f=n.n(S),w=n(2),A=n.n(w),E=n(937),L=n(21),_=n(3341),V=n.n(_),k=n(161),N=n(484),I=n(89),M=n(7),R=n(177),x=n(115),D=n(248),F=n(206),z=n(276),H=n(840),P=n(250),U=n(48),B=(n(4323),n(1));const q={name:A.a.string,annotationType:A.a.string,sourceType:A.a.string,color:A.a.string,opacity:A.a.string,style:A.a.string,width:A.a.number,showMarkers:A.a.bool,hideLine:A.a.bool,value:A.a.oneOfType([A.a.string,A.a.number]),overrides:A.a.object,show:A.a.bool,titleColumn:A.a.string,descriptionColumns:A.a.arrayOf(A.a.string),timeColumn:A.a.string,intervalEndColumn:A.a.string,vizType:A.a.string,theme:A.a.object,error:A.a.string,colorScheme:A.a.string,addAnnotationLayer:A.a.func,removeAnnotationLayer:A.a.func,close:A.a.func},J={name:"",annotationType:H.e,sourceType:"",color:"",opacity:"",style:"solid",width:1,showMarkers:!1,hideLine:!1,overrides:{},colorScheme:"d3Category10",show:!0,titleColumn:"",descriptionColumns:[],timeColumn:"",intervalEndColumn:"",addAnnotationLayer:()=>{},removeAnnotationLayer:()=>{},close:()=>{}};class W extends f.a.PureComponent{constructor(e){var t,n,a,o,i,l,s,r;super(e);const{name:c,annotationType:h,sourceType:u,color:d,opacity:p,style:m,width:y,showMarkers:v,hideLine:b,value:g,overrides:j,show:S,titleColumn:f,descriptionColumns:w,timeColumn:A,intervalEndColumn:E}=e,L=T()(j);(C()(L).call(L,"since")||C()(L).call(L,"until"))&&(j.time_range=null,delete j.since,delete j.until),this.state={name:c,oldName:this.props.name?c:null,annotationType:h,sourceType:u,value:g,overrides:j,show:S,titleColumn:f,descriptionColumns:w,timeColumn:A,intervalEndColumn:E,color:d||"",opacity:p,style:m,width:y,showMarkers:v,hideLine:b,isNew:!this.props.name,isLoadingOptions:!0,valueOptions:[],validationErrors:{}},this.submitAnnotation=O()(t=this.submitAnnotation).call(t,this),this.deleteAnnotation=O()(n=this.deleteAnnotation).call(n,this),this.applyAnnotation=O()(a=this.applyAnnotation).call(a,this),this.fetchOptions=O()(o=this.fetchOptions).call(o,this),this.handleAnnotationType=O()(i=this.handleAnnotationType).call(i,this),this.handleAnnotationSourceType=O()(l=this.handleAnnotationSourceType).call(l,this),this.handleValue=O()(s=this.handleValue).call(s,this),this.isValidForm=O()(r=this.isValidForm).call(r,this)}componentDidMount(){const{annotationType:e,sourceType:t,isLoadingOptions:n}=this.state;this.fetchOptions(e,t,n)}componentDidUpdate(e,t){t.sourceType!==this.state.sourceType&&this.fetchOptions(this.state.annotationType,this.state.sourceType,!0)}getSupportedSourceTypes(e){var t,n,a;const o=v()(t=m()(n=d()(a=Object(k.a)()).call(a)).call(n,({value:t})=>t.canBeAnnotationType(e))).call(t,({key:e,value:t})=>({value:e,label:t.name}));return H.d[e].supportNativeSource&&o.unshift(H.b.NATIVE),o}isValidFormula(e,t){if(t===H.c.FORMULA)try{V.a.parse(e).compile().eval({x:0})}catch(e){return!0}return!1}isValidForm(){const{name:e,annotationType:t,sourceType:n,value:a,timeColumn:o,intervalEndColumn:i}=this.state,l=[Object(N.a)(e),Object(N.a)(t),Object(N.a)(a)];return n!==H.a.NATIVE&&(t===H.c.EVENT&&l.push(Object(N.a)(o)),t===H.c.INTERVAL&&(l.push(Object(N.a)(o)),l.push(Object(N.a)(i)))),l.push(this.isValidFormula(a,t)),!m()(l).call(l,e=>e).length}handleAnnotationType(e){this.setState({annotationType:e,sourceType:null,validationErrors:{},value:null})}handleAnnotationSourceType(e){const{sourceType:t}=this.state;t!==e&&this.setState({sourceType:e,isLoadingOptions:!0,validationErrors:{},value:null})}handleValue(e){this.setState({value:e,descriptionColumns:null,intervalEndColumn:null,timeColumn:null,titleColumn:null,overrides:{time_range:null}})}fetchOptions(e,t,n){!0===n&&(t===H.a.NATIVE?I.a.get({endpoint:"/annotationlayermodelview/api/read?"}).then(({json:e})=>{var t;const n=e?v()(t=e.result).call(t,e=>({value:e.id,label:e.name})):[];this.setState({isLoadingOptions:!1,valueOptions:n})}):Object(H.f)(t)?I.a.get({endpoint:"/superset/user_slices"}).then(({json:t})=>{var n;const a=Object(k.a)();this.setState({isLoadingOptions:!1,valueOptions:v()(n=m()(t).call(t,t=>{const n=a.get(t.viz_type);return n&&n.canBeAnnotationType(e)})).call(n,e=>({value:e.id,label:e.title,slice:e}))})}):this.setState({isLoadingOptions:!1,valueOptions:[]}))}deleteAnnotation(){this.props.close(),this.state.isNew||this.props.removeAnnotationLayer(this.state)}applyAnnotation(){if(this.state.name.length){var e;const t={};h()(e=T()(this.state)).call(e,e=>{null!==this.state[e]&&(t[e]=this.state[e])}),delete t.isNew,delete t.valueOptions,delete t.isLoadingOptions,delete t.validationErrors,t.color=""===t.color?null:t.color,this.props.addAnnotationLayer(t),this.setState(e=>({isNew:!1,oldName:e.name}))}}submitAnnotation(){this.applyAnnotation(),this.props.close()}renderOption(e){return Object(B.e)("span",{className:"optionWrapper",title:e.label},e.label)}renderValueConfiguration(){const{annotationType:e,sourceType:t,value:n,valueOptions:a,isLoadingOptions:o}=this.state;let i="",l="";var s;Object(H.f)(t)?t===H.a.NATIVE?(i="Annotation Layer",l="Select the Annotation Layer you would like to use."):(i=i=Object(M.c)("Chart"),l="Use a pre defined Superset Chart as a source for annotations and overlays.\n        your chart must be one of these visualization types:\n        ["+v()(s=this.getSupportedSourceTypes(e)).call(s,e=>e.label).join(", ")+"]"):e===H.c.FORMULA&&(i="Formula",l="Expects a formula with depending time parameter 'x'\n        in milliseconds since epoch. mathjs is used to evaluate the formulas.\n        Example: '2x+5'");return Object(H.f)(t)?Object(B.e)(D.a,{name:"annotation-layer-value",showHeader:!0,hovered:!0,description:l,label:i,placeholder:"",options:a,isLoading:o,value:n,onChange:this.handleValue,validationErrors:n?[]:["Mandatory"],optionRenderer:this.renderOption}):e===H.c.FORMULA?Object(B.e)(F.a,{name:"annotation-layer-value",hovered:!0,showHeader:!0,description:l,label:i,placeholder:"",value:n,onChange:this.handleValue,validationErrors:this.isValidFormula(n,e)?["Bad formula."]:[]}):""}renderSliceConfiguration(){const{annotationType:e,sourceType:t,value:n,valueOptions:a,overrides:i,titleColumn:s,timeColumn:c,intervalEndColumn:h,descriptionColumns:u}=this.state,{slice:d}=r()(a).call(a,e=>e.value===n)||{};if(t!==H.a.NATIVE&&d){var p,m,y,b,O,g;const t=v()(p=l()(m=d.data.groupby||[]).call(m,d.data.all_columns||[])).call(p,e=>({value:e,label:e})),n=d.data.include_time?l()(y=[{value:"__timestamp",label:"__timestamp"}]).call(y,t):t;return Object(B.e)("div",{style:{marginRight:"2rem"}},Object(B.e)(P.a,{isSelected:!0,onSelect:()=>{},title:"Annotation Slice Configuration",info:"This section allows you to configure how to use the slice\n               to generate annotations."},(e===H.c.EVENT||e===H.c.INTERVAL)&&Object(B.e)(D.a,{hovered:!0,name:"annotation-layer-time-column",label:e===H.c.INTERVAL?"Interval Start column":"Event Time Column",description:"This column must contain date/time information.",validationErrors:c?[]:["Mandatory"],clearable:!1,options:n,value:c,onChange:e=>this.setState({timeColumn:e})}),e===H.c.INTERVAL&&Object(B.e)(D.a,{hovered:!0,name:"annotation-layer-intervalEnd",label:"Interval End column",description:"This column must contain date/time information.",validationErrors:h?[]:["Mandatory"],options:t,value:h,onChange:e=>this.setState({intervalEndColumn:e})}),Object(B.e)(D.a,{hovered:!0,name:"annotation-layer-title",label:"Title Column",description:"Pick a title for you annotation.",options:l()(b=[{value:"",label:"None"}]).call(b,t),value:s,onChange:e=>this.setState({titleColumn:e})}),e!==H.c.TIME_SERIES&&Object(B.e)(D.a,{hovered:!0,name:"annotation-layer-title",label:"Description Columns",description:"Pick one or more columns that should be shown in the\n                  annotation. If you don't select a column all of them will be shown.",multi:!0,options:t,value:u,onChange:e=>this.setState({descriptionColumns:e})}),Object(B.e)("div",{style:{marginTop:"1rem"}},Object(B.e)(z.a,{hovered:!0,name:"annotation-override-time_range",label:"Override time range",description:'This controls whether the "time_range" field from the current\n                  view should be passed down to the chart containing the annotation data.',value:!!r()(O=T()(i)).call(O,e=>"time_range"===e),onChange:e=>{delete i.time_range,e?this.setState({overrides:o()({},i,{time_range:null})}):this.setState({overrides:o()({},i)})}}),Object(B.e)(z.a,{hovered:!0,name:"annotation-override-timegrain",label:"Override time grain",description:"This controls whether the time grain field from the current\n                  view should be passed down to the chart containing the annotation data.",value:!!r()(g=T()(i)).call(g,e=>"time_grain_sqla"===e),onChange:e=>{delete i.time_grain_sqla,delete i.granularity,e?this.setState({overrides:o()({},i,{time_grain_sqla:null,granularity:null})}):this.setState({overrides:o()({},i)})}}),Object(B.e)(F.a,{hovered:!0,name:"annotation-layer-timeshift",label:"Time Shift",description:"Time delta in natural language\n                  (example:  24 hours, 7 days, 56 weeks, 365 days)",placeholder:"",value:i.time_shift,onChange:e=>this.setState({overrides:o()({},i,{time_shift:e})})}))))}return""}renderDisplayConfiguration(){var e;const{color:t,opacity:n,style:a,width:o,showMarkers:i,hideLine:s,annotationType:c}=this.state,h=l()(e=Object(R.a)().get(this.props.colorScheme).colors).call(e);return t&&""!==t&&!r()(h).call(h,e=>e.toLowerCase()===t.toLowerCase())&&h.push(t),Object(B.e)(P.a,{isSelected:!0,onSelect:()=>{},title:Object(M.c)("Display configuration"),info:Object(M.c)("Configure your how you overlay is displayed here.")},Object(B.e)(D.a,{name:"annotation-layer-stroke",label:Object(M.c)("Style"),options:[{value:"solid",label:"Solid"},{value:"dashed",label:"Dashed"},{value:"longDashed",label:"Long Dashed"},{value:"dotted",label:"Dotted"}],value:a,onChange:e=>this.setState({style:e})}),Object(B.e)(D.a,{name:"annotation-layer-opacity",label:Object(M.c)("Opacity"),options:[{value:"",label:"Solid"},{value:"opacityLow",label:"0.2"},{value:"opacityMedium",label:"0.5"},{value:"opacityHigh",label:"0.8"}],value:n,onChange:e=>this.setState({opacity:e})}),Object(B.e)("div",null,Object(B.e)(U.a,{label:Object(M.c)("Color")}),Object(B.e)("div",{style:{display:"flex",flexDirection:"column"}},Object(B.e)(E.CompactPicker,{color:t,colors:h,onChangeComplete:e=>this.setState({color:e.hex})}),Object(B.e)(L.a,{style:{marginTop:"0.5rem",marginBottom:"0.5rem"},buttonStyle:""===t?"success":"default",buttonSize:"xsmall",onClick:()=>this.setState({color:""})},"Automatic Color"))),Object(B.e)(F.a,{name:"annotation-layer-stroke-width",label:Object(M.c)("Line Width"),isInt:!0,value:o,onChange:e=>this.setState({width:e})}),c===H.c.TIME_SERIES&&Object(B.e)(z.a,{hovered:!0,name:"annotation-layer-show-markers",label:"Show Markers",description:"Shows or hides markers for the time series",value:i,onChange:e=>this.setState({showMarkers:e})}),c===H.c.TIME_SERIES&&Object(B.e)(z.a,{hovered:!0,name:"annotation-layer-hide-line",label:"Hide Line",description:"Hides the Line for the time series",value:s,onChange:e=>this.setState({hideLine:e})}))}render(){var e;const{isNew:t,name:n,annotationType:a,sourceType:o,show:i}=this.state,l=this.isValidForm(),{theme:s}=this.props,r=Object(k.a)().get(this.props.vizType),c=r?v()(e=r.supportedAnnotationTypes).call(e,e=>H.d[e]):[],h=this.getSupportedSourceTypes(a);return Object(B.e)(x.a,{theme:s},this.props.error&&Object(B.e)("span",{style:{color:"red"}},"ERROR: ",this.props.error),Object(B.e)("div",{style:{display:"flex",flexDirection:"row"}},Object(B.e)("div",{style:{marginRight:"2rem"}},Object(B.e)(P.a,{isSelected:!0,onSelect:()=>{},title:Object(M.c)("Layer Configuration"),info:Object(M.c)("Configure the basics of your Annotation Layer.")},Object(B.e)(F.a,{name:"annotation-layer-name",label:Object(M.c)("Name"),placeholder:"",value:n,onChange:e=>this.setState({name:e}),validationErrors:n?[]:[Object(M.c)("Mandatory")]}),Object(B.e)(z.a,{name:"annotation-layer-hide",label:Object(M.c)("Hide Layer"),value:!i,onChange:e=>this.setState({show:!e})}),Object(B.e)(D.a,{hovered:!0,description:Object(M.c)("Choose the Annotation Layer Type"),label:Object(M.c)("Annotation Layer Type"),name:"annotation-layer-type",options:c,value:a,onChange:this.handleAnnotationType}),!!h.length&&Object(B.e)(D.a,{hovered:!0,description:"Choose the source of your annotations",label:"Annotation Source",name:"annotation-source-type",options:h,value:o,onChange:this.handleAnnotationSourceType}),this.renderValueConfiguration())),this.renderSliceConfiguration(),this.renderDisplayConfiguration()),Object(B.e)("div",{style:{display:"flex",justifyContent:"space-between"}},Object(B.e)(L.a,{buttonSize:"sm",onClick:this.deleteAnnotation},t?Object(M.c)("Cancel"):Object(M.c)("Remove")),Object(B.e)("div",null,Object(B.e)(L.a,{buttonSize:"sm",disabled:!l,onClick:this.applyAnnotation},Object(M.c)("Apply")),Object(B.e)(L.a,{buttonSize:"sm",disabled:!l,onClick:this.submitAnnotation},Object(M.c)("OK")))))}}W.propTypes=q,W.defaultProps=J}}]);